(function(){function z(a,e){var b=new Point(event.gesture.center.pageX,event.gesture.center.pageY);project.activeLayer.scale(a,a,b);s*=a}function A(a,e){var b=h.hitTest(a,w);return b?(b.item.sui_handler&&b.item.sui_handler(e),!0):!1}function E(a){this.sui_index=p;p+=1;t(this);B();"dragstart"==a&&(m=!0)}function B(){h.remove();h=null;q()}function t(a){for(;a.parent instanceof Group&&a.parent.sui_group;)a=a.parent;for(var e=b.children.length,c=0;c<b.children.length;c++){if(b.children[c]===a)return;
c<e&&b.children[c].sui_index>a.sui_index&&(e=c)}a.remove();b.matrix.set(1,0,0,1,0,0);b.insertChild(e,a);b.sui_index=b.children[0].sui_index;b.remove();e=n.children.length;for(c=0;c<n.children.length;c++)if(n.children[c].sui_index>b.sui_index){e=c;break}n.insertChild(e,b);C();a.strokeColor="blue";q()}function C(){d||(d=new Path.Rectangle(b.bounds),d.insertAbove(b));d.translate(b.bounds.topLeft-d.bounds.topLeft-new Point(4,4));d.scale((b.bounds.width+8)/d.bounds.width,(b.bounds.height+8)/d.bounds.height,
d.bounds.topLeft);d.strokeColor="red";d.selected=!0}function q(){console.log(b);if(h)$('button[id^="menu"]').attr("disabled","disabled");else{if(!$("#add-text").hasClass("hidden")){if(1===b.children.length&&b.children[0]===l){$('button[id^="menu"]').attr("disabled","disabled");return}$("#add-text").addClass("hidden")}$("#menu-btn-add-shape,#menu-btn-add-text").removeAttr("disabled");if(b.children.length){$("#menu-btn-remove,#menu-btn-edit").removeAttr("disabled");var a=$("#menu-btn-group");1!==b.children.length||
b.children[0].sui_group?(a.removeAttr("disabled"),a.text(1===b.children.length?"Ungroup":"Group")):(a.attr("disabled","disabled"),a.text("Group"))}else $("#menu-btn-group,#menu-btn-remove,#menu-btn-edit").attr("disabled","disabled"),$("#menu-btn-group").text("Group")}}function r(){var a=b.removeChildren();b.bringToFront();for(var e=0,c=0;c<a.length;c++){for(;n.children[e]&&n.children[e].sui_index<a[c].sui_index;)e+=1;n.insertChild(e,a[c]);e+=1;a[c].strokeColor="black"}d&&d.remove();d=null;q()}var D=
new Point(200,0),l;$("#menu-btn-add-shape").click(function(){if(!h){r();var a=new Point(100,100),b=new Point(600,600),c=new Path.Rectangle(a,b,10),d=a.x,f=b.x,g=b.y,k;c.fillColor="#ffffff";c.strokeWidth=2;c.strokeColor="green";c.sui_handler=B;h=new Group([c]);for(k=a.x+100-0.5;k<f;k+=100)a.x=b.x=k,c=new Path.Line(a,b),c.strokeColor="green",h.addChild(c);a.x=d;b.x=f;for(k=a.y+100-0.5;k<g;k+=100)a.y=b.y=k,c=new Path.Line(a,b),c.strokeColor="green",h.addChild(c);a=[[new Path.Rectangle(new Point(110,
110),new Point(190,190),10),0],[new Path.Rectangle(new Point(210,110),new Point(290,190)),0],[new Path.Circle(new Point(350,150),40),0],[new Path.RegularPolygon(new Point(450,160),3,45),0],[new Path.RegularPolygon(new Point(550,153),5,40),0],[new Path.RegularPolygon(new Point(150,250),6,40),30],[new Path.RegularPolygon(new Point(250,250),8,40),0],[new Path.Star(new Point(350,250),5,15,7.5*(3+Math.sqrt(5))),36],[new Path.Star(new Point(450,250),6,25,25*Math.sqrt(3)),30]];for(i=0;i<a.length;i++)b=a[i][0],
c=a[i][1],b.fillColor="#ffffff",b.strokeWidth=2,b.strokeColor="black",c&&b.rotate(c),b.sui_handler=E.bind(b),h.addChild(b);q()}});$("#menu-btn-add-text").click(function(){r();$("#text-form").val("");$("#add-text").removeClass("hidden");$("#text-form").focus();l=new PointText(new Point(300,300));l.content="   ";l.style={fontSize:20};l.strokeColor="black";l.sui_index=p;p++;t(l)});$("#text-form").keyup(function(){l&&(console.log(b.bounds),l.content=$("#text-form").val()||"   ",C(),view.draw())});$("#btn-add-text-done").click(function(){$("#add-text").addClass("hidden");
q()});$("#menu-btn-group").click(function(){if(b&&1===b.children.length&&b.children[0].sui_group)b.addChildren(b.children[0].removeChildren()),r();else if(b&&2<=b.children.length){var a=new Group(b.removeChildren());a.sui_index=b.sui_index;a.sui_group=!0;b.addChild(a);$("#menu-btn-group").text("Ungroup")}});$("#menu-btn-remove").click(function(){b.removeChildren();r()});$("#menu-btn-edit").click(function(){console.log(b.strokeColor)});$("#menu-btn-settings").click(function(){});$("#input-color").change(function(){b.strokeColor=
$("#input-color").val()});var w={fill:!0,tolerance:5},F={bounds:!0,tolerance:20};(function(){var a=view.size.width,b=view.size.height,c=new Point(-a,-b),d=new Point(2*a,2*b),f;for(f=-a+19.5;f<2*a;f+=20){c.x=d.x=f;var g=new Path.Line(c,d);g.strokeColor="lightgray"}c.x=-a;d.x=2*a;for(f=-b+19.5;f<2*b;f+=20)c.y=d.y=f,g=new Path.Line(c,d),g.strokeColor="lightgray"})();var g,m,u,v,b=new Group({}),d=null,x=0,y=0,h=null,p=0,s=100,n=new Group({});n.addChild(b);Hammer(view.element).on("pinchin",function(a){g=
m=null;v=!0;30<s&&z(0.95,a)}).on("pinchout",function(a){g=m=null;v=!0;300>s&&z(1.05,a)}).on("dragstart",function(a){if(!v)if(a=new Point(a.gesture.center.pageX,a.gesture.center.pageY)-D,h)A(a,"dragstart");else{var e;if(b.children.length&&(e=d.hitTest(a,F))){"bounds"===e.type&&-1===e.name.indexOf("center")?g=e.name:"fill"===e.type&&(m=!0);return}(e=project.hitTest(a,w))?"fill"===e.type&&(t(e.item),m=!0):u=!0}}).on("drag",function(a){new Point(a.gesture.center.pageX,a.gesture.center.pageY);var e=new Point(a.gesture.deltaX-
x,a.gesture.deltaY-y);m&&(b.translate(e),d.translate(e));if(g){var c=(-1!==g.indexOf("left")?-1:1)*e.x,h=(-1!==g.indexOf("top")?-1:1)*e.y,f;"bottom-left"===g?f=d.bounds.topRight:"top-left"===g?f=d.bounds.bottomRight:"top-right"===g?f=d.bounds.bottomLeft:"bottom-right"===g&&(f=d.bounds.topLeft);d.scale((d.bounds.width+c)/d.bounds.width,(d.bounds.height+h)/d.bounds.height,f);b.translate(d.bounds.topLeft-b.bounds.topLeft+new Point(4,4));b.scale((d.bounds.width-8)/b.bounds.width,(d.bounds.height-8)/b.bounds.height,
b.bounds.topLeft)}u&&project.activeLayer.translate(e);x=a.gesture.deltaX;y=a.gesture.deltaY}).on("dragend",function(a){m=g=u=null;x=y=0}).on("tap",function(a){g=m=u=null;a=new Point(a.gesture.center.pageX,a.gesture.center.pageY)-D;h?A(a,"tap"):(a=project.hitTest(a,w))?"fill"!==a.type||a.item.sui_menu||t(a.item):b.children.length&&r()}).on("release",function(a){v=null});document.body.addEventListener("touchmove",function(a){a.preventDefault()},!1)})();
